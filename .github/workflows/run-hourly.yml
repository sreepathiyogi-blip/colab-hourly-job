name: Meta Ads Reporter - Hourly (Self-Healing)

on:
  schedule:
    # Primary: Every hour at minute 0
    - cron: "0 * * * *"
    # Backup: Every hour at minute 30 (catches missed runs)
    - cron: "30 * * * *"
  
  workflow_dispatch:
    inputs:
      catchup_hours:
        description: 'Hours to catch up (blank = auto-detect)'
        required: false
        type: string
        default: ''

concurrency:
  group: meta-ads-reporter
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            pip install pandas numpy requests gspread gspread-dataframe google-auth google-auth-oauthlib google-auth-httplib2
          fi
      
      - name: Setup Google credentials
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service-account.json
          chmod 600 service-account.json
      
      # NEW: Check for missed hours and catch up
      - name: Detect missed runs
        id: catchup
        run: |
          # Get last successful run time from GitHub API
          LAST_RUN=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/meta_ads_reporter.yml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].created_at // empty')
          
          if [ -n "$LAST_RUN" ]; then
            HOURS_SINCE=$(( ($(date +%s) - $(date -d "$LAST_RUN" +%s)) / 3600 ))
            echo "hours_missed=$((HOURS_SINCE - 1))" >> $GITHUB_OUTPUT
            echo "üìä Last successful run: $LAST_RUN"
            echo "‚è∞ Hours since last run: $HOURS_SINCE"
          else
            echo "hours_missed=0" >> $GITHUB_OUTPUT
            echo "üìä No previous runs found"
          fi
      
      - name: Run with catchup
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account.json
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          CATCHUP_HOURS: ${{ inputs.catchup_hours || steps.catchup.outputs.hours_missed }}
          TZ: Asia/Kolkata
          PYTHONUNBUFFERED: "1"
        run: |
          echo "=============================================="
          echo "üöÄ META ADS REPORTER - HOURLY UPDATE"
          echo "=============================================="
          echo "üìÖ Date: $(TZ=Asia/Kolkata date '+%Y-%m-%d')"
          echo "üïê Time (IST): $(TZ=Asia/Kolkata date '+%H:%M:%S %Z')"
          echo "üïê Time (UTC): $(date -u '+%H:%M:%S %Z')"
          echo "üìä Run: #${{ github.run_number }}"
          
          if [ "${CATCHUP_HOURS:-0}" -gt 0 ]; then
            echo "üîÑ CATCHUP MODE: Processing $CATCHUP_HOURS missed hour(s)"
          else
            echo "‚úÖ NORMAL MODE: Current hour only"
          fi
          
          echo "=============================================="
          echo ""
          
          python meta_ads_reporter.py
          
          echo ""
          echo "=============================================="
          echo "‚úÖ UPDATE COMPLETED"
          echo "üïê Finished (IST): $(TZ=Asia/Kolkata date '+%H:%M:%S %Z')"
          echo "=============================================="
      
      - name: Cleanup credentials
        if: always()
        run: rm -f service-account.json
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            *.log
            *.txt
          retention-days: 7
